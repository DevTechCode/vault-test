name: Terraform Deploy

on:
  push:
      branches:
        - main
      paths:
      - '**/*.tf'
      - '**/*.tfvars'
      - '**/*.yaml'
      - '**/*.yml'
      - '**/*.json'
      - '**/*.hcl'
      - '.github/workflows/**'

permissions:
  id-token: write
  contents: read

jobs:

  # üëá Terraform deploy zostawiam bez zmian (zakomentowane)
  # terraform-deploy-g03:
  #   ...

  # terraform-deploy-g00:
  #   ...

  trigger-sa-job-analytics-accounts:
    name: Trigger SA Job - Analytics Accounts

    # üî• uruchomi siƒô TYLKO w momencie merge PR
    # i TYLKO je≈õli brancha ma prefix auto_add_analytics_account_
    # if: 
    #   startsWith((github.ref_name), 'auto_add_analytics_account_')

    runs-on: traffic-runners

    steps:
      - uses: actions/checkout@v6

      - name: Extract analytics account from branch name
        id: extract-account
        run: |
          BRANCH="${{ github.ref_name }}"

          PREFIX="auto_add_analytics_account_"

          # sprawdzamy czy branch zaczyna siƒô od poprawnego prefixu
          if [[ "$BRANCH" != $PREFIX* ]]; then
            echo "Error: branch name does not match expected prefix: $PREFIX"
            exit 1
          fi

          # wyciƒÖgniƒôcie nazwy konta
          ACCOUNT="${BRANCH#$PREFIX}"

          if [[ -z "$ACCOUNT" ]]; then
            echo "Error: extracted analytics account is empty"
            exit 1
          fi

          echo "Extracted account: $ACCOUNT"
          echo "account=$ACCOUNT" >> $GITHUB_OUTPUT

      - name: Trigger SA Jenkins job
        env:
          ANALYTICS_ACCOUNT: ${{ steps.extract-account.outputs.account }}
        run: |
          set -euo pipefail

          curl -X POST "http://localhost:8080/test" \
            -H "Content-Type: application/json" \
            -d "{\"account\": \"${ANALYTICS_ACCOUNT}\", \"reason\": \"Personal changes in the access group.\"}"

          echo "üëç Sent request to localhost for account: $ANALYTICS_ACCOUNT"
